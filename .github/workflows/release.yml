name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-deb:
    strategy:
      matrix:
        include:
          - distro: ubuntu
            version: "20.04"
            container: ubuntu:20.04
          - distro: ubuntu
            version: "22.04"
            container: ubuntu:22.04
          - distro: ubuntu
            version: "24.04"
            container: ubuntu:24.04
          - distro: debian
            version: "11"
            container: debian:11
          - distro: debian
            version: "12"
            container: debian:12
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
          TZ: Etc/UTC
        run: |
          apt-get update
          apt-get install -y curl build-essential pkg-config libssl-dev
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

      - name: Build release binary and .deb package
        run: |
          . $HOME/.cargo/env
          cargo install cargo-deb
          cargo build --release -p pcapsql-datafusion
          cargo deb -p pcapsql-datafusion --no-build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.distro }}-${{ matrix.version }}
          path: target/debian/*.deb

  build-rpm:
    strategy:
      matrix:
        include:
          - distro: fedora
            version: "39"
            container: fedora:39
          - distro: fedora
            version: "40"
            container: fedora:40
          - distro: el
            version: "9"
            container: rockylinux:9
    runs-on: ubuntu-latest
    container: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          # Note: curl-minimal is pre-installed and sufficient for rustup
          dnf install -y gcc openssl-devel
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

      - name: Build release binary and .rpm package
        run: |
          . $HOME/.cargo/env
          cargo install cargo-generate-rpm
          cargo build --release -p pcapsql-datafusion
          cargo generate-rpm -p pcapsql-datafusion

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-${{ matrix.distro }}-${{ matrix.version }}
          path: target/generate-rpm/*.rpm

  release:
    needs: [build-deb, build-rpm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Organize packages by distro
        run: |
          mkdir -p release-assets
          for dir in packages/deb-*; do
            if [ -d "$dir" ]; then
              distro=$(basename "$dir" | sed 's/deb-\(.*\)-\([0-9.]*\)/\1/')
              version=$(basename "$dir" | sed 's/deb-\(.*\)-\([0-9.]*\)/\2/')
              mkdir -p "release-assets/$distro/$version"
              cp "$dir"/*.deb "release-assets/$distro/$version/"
            fi
          done
          for dir in packages/rpm-*; do
            if [ -d "$dir" ]; then
              distro=$(basename "$dir" | sed 's/rpm-\(.*\)-\([0-9.]*\)/\1/')
              version=$(basename "$dir" | sed 's/rpm-\(.*\)-\([0-9.]*\)/\2/')
              mkdir -p "release-assets/$distro/$version"
              cp "$dir"/*.rpm "release-assets/$distro/$version/"
            fi
          done
          echo "Package structure:"
          find release-assets -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/**/*
          generate_release_notes: true
